# 匠測定システム アルゴリズム解説

本ドキュメントでは、匠測定システムで使用される各評価アルゴリズムについて詳細に解説します。

## 1. 評価の全体構造

匠測定システムは以下の3つの主要な評価軸で技能を測定します：

- **精密性 (Precision)**: 40%
- **冷静さ (Calmness)**: 30%
- **器用さ (Dexterity)**: 30%

最終スコアは0〜100点で算出され、以下のランクに分類されます：

- **SSS**: 96点以上
- **S**: 86点以上
- **A**: 71点以上
- **B**: 41点以上
- **C**: 40点以下

## 2. 描画分析アルゴリズム (DrawingAnalyzer)

### 2.1 円の精度分析 (analyzeCircleAccuracy)

目標とする円からの逸脱度を測定します。

**アルゴリズム：**

1. **各点の逸脱度計算**
   ```
   距離 = √((x - 中心x)² + (y - 中心y)²)
   逸脱度 = |距離 - 目標半径|
   ```

2. **精度スコア算出**
   ```
   平均逸脱度 = Σ逸脱度 / 点の数
   精度 = max(0, 1 - (平均逸脱度 / 目標半径))
   ```

3. **完成度計算**
   - 始点と終点の角度差から、円の何割を描いたかを算出
   - 角度差が2πに近いほど完成度が高い

### 2.2 滑らかさ分析 (analyzeSmoothness)

連続する3点間の角度変化から線の滑らかさを評価します。

**アルゴリズム：**

1. 連続する3点 (P₁, P₂, P₃) に対して：
   - 角度1 = atan2(P₂.y - P₁.y, P₂.x - P₁.x)
   - 角度2 = atan2(P₃.y - P₂.y, P₃.x - P₂.x)
   - 角度差 = |角度2 - 角度1|

2. 滑らかさスコア = max(0, 1 - (平均角度変化 / π))

### 2.3 手の震え検出 (detectHandTremor)

描画速度の変動から手の震えを検出します。

**アルゴリズム：**

1. 各点での速度を計算：
   ```
   速度 = 距離 / 時間差
   ```

2. 速度の分散を計算し、平均速度で正規化：
   ```
   震え度 = min(1, 速度の分散 / 平均速度²)
   ```

### 2.4 速度一貫性分析 (analyzeSpeedConsistency)

描画速度の一貫性を評価します。

**アルゴリズム：**

```
標準偏差 = √(Σ(速度 - 平均速度)² / n)
一貫性 = max(0, 1 - (標準偏差 / 平均速度))
```

## 3. 顔分析アルゴリズム (FaceAnalyzer)

### 3.1 呼吸検出 (detectBreathing)

顔のランドマークから呼吸パターンを検出します。

**アルゴリズム：**

1. face-api.jsを使用して68個の顔ランドマークを検出
2. 鼻先（ランドマーク[30]）と顎（ランドマーク[8]）の距離を測定
3. この距離の変化から呼吸パターンを推定

### 3.2 表情分析 (analyzeFacialExpression)

7つの基本表情から冷静さスコアを算出します。

**アルゴリズム：**

```
冷静さスコア = 
  neutral × 0.7 + 
  happy × 0.3 - 
  angry × 0.5 - 
  surprised × 0.3 -
  disgusted × 0.4 -
  fearful × 0.4 -
  sad × 0.3
```

各表情の確率は0〜1の範囲で、face-api.jsの表情認識モデルによって算出されます。

### 3.3 呼吸安定性分析 (analyzeBreathingStability)

呼吸の規則性と基準値からの逸脱を評価します。

**アルゴリズム：**

1. 最近の呼吸データの分散を計算
2. 基準値（キャリブレーション時の平均）からの逸脱率を計算
3. 安定性スコア = 1 - min(1, (分散/100 + 逸脱率))

## 4. 総合評価アルゴリズム (EvaluationEngine)

### 4.1 精密性スコア (calculatePrecisionScore)

描画データから精密性を評価します。

**構成要素と重み：**
- 円の精度: 50%
- 滑らかさ: 30%
- 完成度: 20%

### 4.2 冷静さスコア (calculateCalmnessScore)

生理学的データから精神的な落ち着きを評価します。

**構成要素と重み：**
- 呼吸の安定性: 40%
- 表情の冷静さ: 30%
- ストレス耐性: 30%

### 4.3 器用さスコア (calculateDexterityScore)

手の制御能力を評価します。

**構成要素と重み：**
- 速度の一貫性: 35%
- 手の安定性（震えの少なさ）: 35%
- 回復速度: 30%

**回復速度の正規化：**
```
理想的な回復時間 = 5秒
最大許容時間 = 15秒

正規化スコア = {
  1.0 (5秒以下)
  1 - ((実際の時間 - 5) / 10) (5〜15秒)
  0.0 (15秒以上)
}
```

## 5. アドバイス生成ロジック

システムは以下の手順でパーソナライズされたアドバイスを生成します：

1. **最弱点の特定**: 3つの評価軸の中で最も低いスコアの分野を特定
2. **ランク別アドバイス**: 各分野とランクの組み合わせに応じた具体的な改善提案
3. **運転適性評価**: 総合スコアに基づいた運転時の注意事項

### 運転適性の判定基準

- **SSS/S**: 優秀な運転適性（プロドライバーレベル）
- **A**: 良好な運転適性（安全運転推奨）
- **B**: 標準的な運転適性（定期的な休憩必要）
- **C**: 注意が必要（体調万全時のみ、長距離避ける）

## 6. 技術的な実装詳細

### 使用ライブラリ

- **face-api.js**: 顔検出と表情認識
  - TinyFaceDetector: 軽量な顔検出モデル
  - FaceLandmark68Net: 68点の顔ランドマーク検出
  - FaceExpressionNet: 7つの基本表情の認識

### パフォーマンス最適化

- 顔検出の入力サイズを224pxに制限して処理速度を向上
- スコアしきい値を0.5に設定して誤検出を防止
- リアルタイム処理のため、単一顔検出モードを使用

### 数値の正規化

すべてのスコアは0〜100の範囲に正規化され、以下の制約が適用されます：

```javascript
スコア = Math.min(100, Math.max(0, 計算値))
```

これにより、異常値や計算エラーによる範囲外の値を防止しています。